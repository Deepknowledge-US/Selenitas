{"ast":null,"code":"'use strict';\n/**\n * Module dependencies\n */\n\nvar xtend = require('xtend');\n\nvar Readable = require('readable-stream').Readable;\n\nvar streamsOpts = {\n  objectMode: true\n};\nvar defaultStoreOptions = {\n  clean: true\n};\n/**\n * In-memory implementation of the message store\n * This can actually be saved into files.\n *\n * @param {Object} [options] - store options\n */\n\nfunction Store(options) {\n  if (!(this instanceof Store)) {\n    return new Store(options);\n  }\n\n  this.options = options || {}; // Defaults\n\n  this.options = xtend(defaultStoreOptions, options);\n  this._inflights = new Map();\n}\n/**\n * Adds a packet to the store, a packet is\n * anything that has a messageId property.\n *\n */\n\n\nStore.prototype.put = function (packet, cb) {\n  this._inflights.set(packet.messageId, packet);\n\n  if (cb) {\n    cb();\n  }\n\n  return this;\n};\n/**\n * Creates a stream with all the packets in the store\n *\n */\n\n\nStore.prototype.createStream = function () {\n  var stream = new Readable(streamsOpts);\n  var destroyed = false;\n  var values = [];\n  var i = 0;\n\n  this._inflights.forEach(function (value, key) {\n    values.push(value);\n  });\n\n  stream._read = function () {\n    if (!destroyed && i < values.length) {\n      this.push(values[i++]);\n    } else {\n      this.push(null);\n    }\n  };\n\n  stream.destroy = function () {\n    if (destroyed) {\n      return;\n    }\n\n    var self = this;\n    destroyed = true;\n    setTimeout(function () {\n      self.emit('close');\n    }, 0);\n  };\n\n  return stream;\n};\n/**\n * deletes a packet from the store.\n */\n\n\nStore.prototype.del = function (packet, cb) {\n  packet = this._inflights.get(packet.messageId);\n\n  if (packet) {\n    this._inflights.delete(packet.messageId);\n\n    cb(null, packet);\n  } else if (cb) {\n    cb(new Error('missing packet'));\n  }\n\n  return this;\n};\n/**\n * get a packet from the store.\n */\n\n\nStore.prototype.get = function (packet, cb) {\n  packet = this._inflights.get(packet.messageId);\n\n  if (packet) {\n    cb(null, packet);\n  } else if (cb) {\n    cb(new Error('missing packet'));\n  }\n\n  return this;\n};\n/**\n * Close the store\n */\n\n\nStore.prototype.close = function (cb) {\n  if (this.options.clean) {\n    this._inflights = null;\n  }\n\n  if (cb) {\n    cb();\n  }\n};\n\nmodule.exports = Store;","map":{"version":3,"sources":["/home/one/node_modules/mqtt/lib/store.js"],"names":["xtend","require","Readable","streamsOpts","objectMode","defaultStoreOptions","clean","Store","options","_inflights","Map","prototype","put","packet","cb","set","messageId","createStream","stream","destroyed","values","i","forEach","value","key","push","_read","length","destroy","self","setTimeout","emit","del","get","delete","Error","close","module","exports"],"mappings":"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","sourcesContent":["'use strict'\n\n/**\n * Module dependencies\n */\nvar xtend = require('xtend')\n\nvar Readable = require('readable-stream').Readable\nvar streamsOpts = { objectMode: true }\nvar defaultStoreOptions = {\n  clean: true\n}\n\n/**\n * In-memory implementation of the message store\n * This can actually be saved into files.\n *\n * @param {Object} [options] - store options\n */\nfunction Store (options) {\n  if (!(this instanceof Store)) {\n    return new Store(options)\n  }\n\n  this.options = options || {}\n\n  // Defaults\n  this.options = xtend(defaultStoreOptions, options)\n\n  this._inflights = new Map()\n}\n\n/**\n * Adds a packet to the store, a packet is\n * anything that has a messageId property.\n *\n */\nStore.prototype.put = function (packet, cb) {\n  this._inflights.set(packet.messageId, packet)\n\n  if (cb) {\n    cb()\n  }\n\n  return this\n}\n\n/**\n * Creates a stream with all the packets in the store\n *\n */\nStore.prototype.createStream = function () {\n  var stream = new Readable(streamsOpts)\n  var destroyed = false\n  var values = []\n  var i = 0\n\n  this._inflights.forEach(function (value, key) {\n    values.push(value)\n  })\n\n  stream._read = function () {\n    if (!destroyed && i < values.length) {\n      this.push(values[i++])\n    } else {\n      this.push(null)\n    }\n  }\n\n  stream.destroy = function () {\n    if (destroyed) {\n      return\n    }\n\n    var self = this\n\n    destroyed = true\n\n    setTimeout(function () {\n      self.emit('close')\n    }, 0)\n  }\n\n  return stream\n}\n\n/**\n * deletes a packet from the store.\n */\nStore.prototype.del = function (packet, cb) {\n  packet = this._inflights.get(packet.messageId)\n  if (packet) {\n    this._inflights.delete(packet.messageId)\n    cb(null, packet)\n  } else if (cb) {\n    cb(new Error('missing packet'))\n  }\n\n  return this\n}\n\n/**\n * get a packet from the store.\n */\nStore.prototype.get = function (packet, cb) {\n  packet = this._inflights.get(packet.messageId)\n  if (packet) {\n    cb(null, packet)\n  } else if (cb) {\n    cb(new Error('missing packet'))\n  }\n\n  return this\n}\n\n/**\n * Close the store\n */\nStore.prototype.close = function (cb) {\n  if (this.options.clean) {\n    this._inflights = null\n  }\n  if (cb) {\n    cb()\n  }\n}\n\nmodule.exports = Store\n"]},"metadata":{},"sourceType":"script"}